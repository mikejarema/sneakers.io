<!doctype html>
<html>
<head>
<link href='/favicon.ico' rel='icon' type='image/x-icon'/>
<meta charset="utf-8" />
<meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
<title>Sneakers Blog  - Monitoring Sneakers</title>
<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,700' rel='stylesheet' type='text/css'>

  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
  <link href="/stylesheets/app.css" rel="stylesheet" type="text/css" />

</head>
<body>
  
<header class="navigation">
  <div class="navigation-wrapper">
    <div class="navigation-content">
      <div style="padding:0px">
        <a href="/" class="logo">
          <img src="/images/main_logo.png" alt="Logo Image">
        </a>
      </div>
      <a href="" class="navigation-menu-button" id="js-mobile-menu">MENU</a>
      <div class="nav">
        <ul id="navigation-menu">
          <li class="nav-link "><a href="/">Home</a></li>
          <li class="nav-link selected"><a href="/blog">Blog</a></li>
          <li class="nav-link"><a href="https://github.com/jondot/sneakers/wiki">Docs</a></li>
          <li class="nav-link">
          <a class="fork" href="https://github.com/jondot/sneakers"><i class="fa fa-github"></i> Fork on Github &rarr;</a></li>
        </ul>
      </div>
    </div>
  </div>
</header>


  <div class="blog-content">
    <main class="blog-main">
          <h1 class="article-title"><a href="/blog/2014/12/09/monitoring-sneakers.html">Monitoring Sneakers</a></h1>
<div class="article_head">
  <div class="article_head-author">
    <img src="http://www.gravatar.com/avatar/7bab8ed9cad2d098076b61b7cc3b8030?s=32.jpg" alt=""/>
    <a href="http://twitter.com/jondot">Dotan Nahum</a>, Dec  9
  </div>
</div>


      <p>I'll show one of my production Sneakers deployment and the some of tiers I've chosen for monitoring it.</p>

<h4 id="monitoring-message-handling">Monitoring Message Handling</h4>

<p>In this specific use case, each "bundle" may contain several "events", which is a simple bulking technique. Here we're averaging and counting the number of events per bundle.</p>

<p>In itself an important metric to measure, to expose a bad / error prone bulking strategy.</p>

<p><img alt="" src="/images/blog/events-in-bundle.png" /></p>

<p>A good practice is to always measure the average payload size - the size of a message passed to a worker. Again this is a kind of parameter that may affect job handling time and may expose misconfiguration / errors with original messages.</p>

<p>The size of a message and rate of messages are also useful in computing and monitoring the network capacity and saturation.</p>

<p><img alt="" src="/images/blog/payload-bytes.png" /></p>

<h4 id="monitoring-worker-metrics">Monitoring Worker Metrics</h4>

<p>A job's latency is very important. Here you can measure and learn about the profile of your work. With this information you can decide how to scale up / down your workers. </p>

<p>This metric along with the CPU's state will help you answer questions such as are jobs I/O bound? are they CPU bound?</p>

<p><img alt="" src="/images/blog/job-latency.png" /></p>

<p>Job/sec is the ultimate eyecandy metric; Beyond that, it is also a very useful tool to base any anomaly / spike detection on with your jobs. It's also one of the metrics that you should always find changing - seasonality, peaks, spikes, etc.</p>

<p><img alt="" src="/images/blog/jobs-sec.png" /></p>

<p>Worker errors are errors that aren't handled by any of your code. Very useful for a baseline for monitoring.</p>

<p><img alt="" src="/images/blog/worker-errors.png" /></p>

<h4 id="monitoring-rabbitmq">Monitoring RabbitMQ</h4>

<p>A great set of practices for Monitoring RabbitMQ is the same set for most queue brokers.</p>

<p>Here's a few ideas to get you running:</p>

<ol>
  <li>A queue with no activity (no push, no drain) is a bad queue.</li>
  <li>A queue should always have traffic in + traffic out.</li>
  <li>A queue should have a LWA (Low-watermark-alert), and HWA (High-watermark-alert). Set your own based on your learnt real-world metrics.</li>
  <li>A queue should always be draining. A queue's level should not be monotonically increasing forever (or a given acceptable time-window).</li>
</ol>

<h4 id="monitoring-server-vitals">Monitoring Server Vitals</h4>

<p>When you're trying to troubleshoot a sneaky problem, server vitals can increase the resolution and usually would provide an answer to your problems.</p>

<p>Starting off with CPU, obviously. This is cpu-idle:</p>

<p><img alt="" src="/images/blog/cpu-idle.png" /></p>

<p>Many threads, many processes generate a lot of contention and context switches. You want to be able to visualize the bottlenecks.</p>

<p><img alt="" src="/images/blog/context-switches.png" /></p>

<p>Ruby processes may become notoriously memory-hungry. This is real free memory:</p>

<p><img alt="" src="/images/blog/free-mem.png" /></p>

<p>If your worker interacts with the world, it's useful to monitor the amount of open connections. Open connections run out quickly on a high-scale solution. This is open connections:</p>

<p><img alt="" src="/images/blog/open-web-connections.png" /></p>

<h4 id="conclusion">Conclusion</h4>

<p>There's no such thing as too much metrics (actually there is, but let's pretend there isn't). Once you bump into a hard problem in the field of background processing, the nature of it being async makes the problem very illusive.</p>

<p>You have to have some kind of historical viewport where you can examine and cross-reference several worker-level, job-level, and hardware-level metrics.</p>


    </main>
    <aside class="blog-aside">
      Want to be featured here?<br/>
      <a href="https://github.com/jondot/sneakers.io" >Submit a pull request</a>
      
      <h4>Recent Articles</h4>
      <ol class="blog-recent">
        <li>
          <a href="/blog/2014/12/10/the-new-website.html">Sneakers 1.0 - The New Website</a>
        </li>
        <li>
          <a href="/blog/2014/12/09/monitoring-sneakers.html">Monitoring Sneakers</a>
        </li>
        <li>
          <a href="/blog/2014/12/04/modular-workers.html">Modular Workers for Easier Testing and Development</a>
        </li>
        <li>
          <a href="/blog/2014/11/21/what-weve-been-through.html">What We've Been Trough</a>
        </li>
      </ol>
      <hr />
      <h4>Tags</h4>
      <ol>
      </ol>
      <h4>By Year</h4>
      <ol>
      <li><a href="/blog/2014.html">2014 (4)</a></li>
      </ol>
      <div class="blog-minihero">
        <hr />
        <ul class="blog-socials">
          <li>
            <a href="http://twitter.com/jondot"><i class="fa fa-twitter"></i></a>
          </li>
          <li>
            <a href="https://github.com/jondot/sneakers"><i class="fa fa-github"></i></a>
          </li>
          <li>
            <a href="/blog/feed.xml"><i class="fa fa-rss"></i></a>
          </li>
        </ul>
      </div>
    </aside>
  </div>
  <footer class="footer">
  <div class="footer-logo">
  </div>
  <div class="footer-links">
    <ul>
      <li><h3>Learn</h3></li>
      <li><a href="https://github.com/jondot/sneakers/wiki">Docs</a></li>
      <li><a href="/blog">Blog</a></li>
    </ul>
    <ul>
      <li><h3>Follow</h3></li>
      <li><a href="https://github.com/jondot/sneakers">Github</a></li>
      <li><a href="http://twitter.com/jondot">Follow @jondot</a></li>
      <li><a href="mailto:jondotan@gmail.com">Say hi :)</a></li>
    </ul>
    <ul>
      <li><h3>Community</h3></li>
      <li><a href="https://github.com/jondot/sneakers/issues">Issues</a></li>
      <li><a href="https://github.com/jondot/sneakers#contributing">How to Contribute</a></li>
      <li><a href="https://github.com/jondot/sneakers/wiki">Getting Help</a></li>
    </ul>
  </div>
  <p>
  Copyright Â© 2014 Dotan Nahum and contributors - Licensed under MIT.
  </p>
</footer>



  <script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create','UA-7131053-14');ga('send','pageview');
  </script>
</body>
</html>
